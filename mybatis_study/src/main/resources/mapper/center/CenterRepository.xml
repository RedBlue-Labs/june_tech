<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mybatis_study.center.repository.CenterRepository">
    <select id="findTotalCenters" resultType="Center">
        SELECT name,
               regDt,
               email
          FROM center
    </select>

    <resultMap id="MemberCollectionMap" type="Member">
        <id property="id" column="member_id"/>
        <result property="name" column="member_name"/>
        <result property="regDt" column="member_reg_dt"/>
        <result property="email" column="member_email"/>
        <result property="centerId" column="member_center_id"/>
    </resultMap>
    
    <resultMap id="MemberInfoMap" type="MemberInfo">
        <id property="centerId" column="center_id"/>
        <result property="centerName" column="center_name"/>
        <result property="centerRegDt" column="center_reg_dt"/>
        <result property="centerEmail" column="center_email"/>
        <collection property="members" ofType="Member" resultMap="MemberCollectionMap"/>
    </resultMap>

    <select id="findMemberFromCenter" resultMap="MemberInfoMap">
        SELECT c.id as center_id,
               c.name as center_name,
               c.regDt as center_reg_dt,
               c.email as center_email,
               m.id as member_id,
               m.name as member_name,
               m.regDt as member_reg_dt,
               m.email as member_email,
               m.centerId as member_center_id
          FROM CENTER c
LEFT OUTER JOIN MEMBER m
            ON c.ID = m.CENTERID
         WHERE c.ID = #{centerId}
    </select>

    <resultMap id="MemberNestedMap" type="MemberInfo">
        <id property="centerId" column="center_id"/>
        <result property="centerName" column="center_name"/>
        <result property="centerRegDt" column="center_reg_dt"/>
        <result property="centerEmail" column="center_email"/>
        <collection property="members" column="{centerId = center_id}" javaType="java.util.ArrayList" ofType="Member" select="findMemberSubQuery"/>
    </resultMap>

    <select id="findMemberSubQuery" resultType="Member">
        SELECT id,
               name,
               regDt,
               email,
               centerId
          FROM MEMBER
         WHERE centerId = #{centerId}
    </select>

    <select id="findMemberNestedSelect" resultMap="MemberNestedMap">
        SELECT id as center_id,
               name as center_name,
               regDt as center_reg_dt,
               email as center_email
        FROM CENTER
        WHERE id = #{centerId}
    </select>


    <select id="findMemberNestedSelectNPlusOne" resultMap="MemberNestedMap">
        SELECT id as center_id,
               name as center_name,
               regDt as center_reg_dt,
               email as center_email
          FROM CENTER
    </select>

    <select id="findMemberNestedSelectJoin" resultMap="MemberInfoMap">
        SELECT c.id as center_id,
               c.name as center_name,
               c.regDt as center_reg_dt,
               c.email as center_email,
               m.id as member_id,
               m.name as member_name,
               m.regDt as member_reg_dt,
               m.email as member_email,
               m.centerId as member_center_id
          FROM CENTER c
LEFT OUTER JOIN MEMBER m
            ON c.ID = m.CENTERID
    </select>
</mapper>